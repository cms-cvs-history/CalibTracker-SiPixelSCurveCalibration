process SCurveCalibration =  {
  
######################################################
#  define the number of events to run on (-1 = all)
######################################################

untracked PSet maxEvents = {untracked int32 input = -1}

#############################################
# Input source
#############################################

   include "IORawData/SiPixelInputSources/data/PixelSLinkDataInputSource.cfi"

#############################################
#   definition of the input file that contains the raw data
#   see https://twiki.cern.ch/twiki/bin/view/CMS/TIF_and_PSI_data 
#   for location of files
#############################################
   replace PixelSLinkDataInputSource.fileNames={'rfio:/castor/cern.ch/cms/store/TAC/PIXEL/FPIX/HC+Z1/SCurve_565.dmp'}  # your file here
   #replace PixelSLinkDataInputSource.fileNames={'file:/FPixData/FPIX/HC+Z1/Runs_warm_562_565/SCurve_565.dmp'}         # example of local filesystem synatx

   include "CalibTracker/SiPixelGainCalibration/data/SiPixelCalibDigiProducer.cfi"



#############################################
# raw to digi
#############################################

    include "EventFilter/SiPixelRawToDigi/data/SiPixelRawToDigi.cfi"
    replace siPixelDigis.InputLabel = "source"
#############################################
# make sure the error collection is included...
#############################################
    replace siPixelDigis.IncludeErrors = true

#############################################
#   create calibdigis
#############################################

    include "CalibTracker/SiPixelGainCalibration/data/SiPixelCalibDigiProducer.cfi"
    replace siPixelCalibDigis.src = "siPixelDigis"


############################################################
# include the settings for SiPixelSCurveCalibrationAnalysis.cfi, change option to write zero threshold values into file
############################################################

include "CalibTracker/SiPixelSCurveCalibration/data/SiPixelSCurveCalibrationAnalysis.cfi"
#replace siPixelSCurveAnalysis.WriteZeroes = false

############################################################
# location of histogram output
############################################################
replace siPixelSCurveAnalysis.outputFileName = "scurve_histograms.root"

############################################################
# save curves from bad pixels, if desired.  Note that the 
# maximum number of bad curves to save is definited in the ../data/SiPixelSCurveCalibrationAnalysis.cfi
# with the default value of 1000.  Be careful - corrupted data will cause HUGE 
# memory consumption if this is set too high.
############################################################

#replace siPixelSCurveAnalysis.saveCurvesThatFlaggedBad = true

############################################################
# these settings dictate the points at which curves will be flagged bad.  Uncomment if desired.
# see ../data/SiPixelOfflineCalibAnalysis.cfi for more options
############################################################

#replace siPixelSCurveAnalysis.minimumChi2prob          = 0.9
#replace siPixelSCurveAnalysis.maximumSigma             = 4

############################################################
# Save curves from ALL pixels on a a list of given DetID (plaquette/module)
# Watch out for LARGE memory consumption if you enable this. Note that
# you must use CMSSW numbering conventions for DetIDs
# for performance reasons, and saveCurvesThatFlaggedBad must
# be set to "true"
############################################################

#replace siPixelSCurveAnalysis.detIDsToSave              = { 352394505, 352394512 } 

############################################################
# include DQM services
############################################################
 
    include "DQMServices/Core/data/DQM.cfg"

############################################################
# Logging options
############################################################

service = MessageLogger {
    untracked vstring destinations = { "./output" }  # writes to ./output.log
                                     
    untracked vstring categories = { "SiPixelSCurveCalibration", "SiPixelOfflineCalibAnalysisBase" , "SiPixelSCurveCalibrationHistogramReport"}
    untracked PSet output = {
#               untracked string threshold = "INFO"             # use me instead of WARNING for LOTS of informative output
                untracked string threshold = "WARNING"
                untracked PSet FwkReport  = { untracked int32 reportEvery = 200 }
                untracked PSet SiPixelSCurveCalibration = { untracked int32 limit = 100 }
                untracked PSet SiPixelSCurveCalibrationHistogramReport = { untracked int32 limit = 1000 }
                untracked PSet SiPixelOfflineCalibAnalysisBase = { untracked int32 limit = 1000 }
    }
}

############################################################
# databases, cabling maps and geometry
############################################################

   include "CondTools/SiPixel/data/SiPixelCalibConfiguration.cfi"
   replace sipixelcalib_essource.toGet = { 
	{ 
	    string record = "SiPixelCalibConfigurationRcd"
	    # change the tag appropriately. 
	    # This tag string controls which calibration information is used and for now should match the used datafile.
	    string tag = "SCurve_565"
	},
	{ # this is cabling information, it contains the cabling map
	    string record = "SiPixelFedCablingMapRcd"
	    string tag = "SiPixelFedCablingMap_v9"
	}
    }

    include "Geometry/TrackerSimData/data/trackerSimGeometryXML.cfi"
    include "Geometry/TrackerGeometryBuilder/data/trackerGeometry.cfi"
    include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"

module filterEmptyCalibDigis = SiPixelCalibDigiFilter {}

path p = {siPixelDigis, siPixelCalibDigis, siPixelSCurveAnalysis} 

}
